
<html>
    <head>
        <!-- About import maps, see the Three.js official docs: -->
        <!-- https://threejs.org/docs/#manual/en/introduction/Installation -->
        <script async src="https://unpkg.com/es-module-shims@1.3.6/dist/es-module-shims.js"></script>

        <script type="importmap">
            {
                "imports": {
                "three": "https://unpkg.com/three@0.150.1/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.150.1/examples/jsm/",
                "@pixiv/three-vrm": "/node_modules/@pixiv/three-vrm/lib/three-vrm.module.js"
                }
            }
        </script>

        <script type="module">

            import * as THREE from 'three';
            import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
            import { VRMLoaderPlugin, VRMUtils } from '@pixiv/three-vrm';
            import { OrbitControls } from 'three/addons/controls/OrbitControls.js';


            var vrm

            window.addEventListener("DOMContentLoaded", () => {
                var width = 500;
                var height = 250;

                const canvas = document.getElementById('canvas')

                var scene = new THREE.Scene();

                const camera = new THREE.PerspectiveCamera(45, canvas.clientWidth/canvas.clientHeight, 0.1, 1000)
                camera.position.set(0, 1, -3)
                camera.rotation.set(0, Math.PI, 0)

                const renderer = new THREE.WebGLRenderer({antialias: true});
                renderer.setPixelRatio(window.devicePixelRatio)
                renderer.setSize(canvas.clientWidth, canvas.clientHeight)
                renderer.setClearColor(0x7fbfff, 1.0)

                const controls = new OrbitControls( camera, renderer.domElement );
                canvas.appendChild(renderer.domElement)

                const light = new THREE.DirectionalLight(0xffffff)
                light.position.set(-1, 1, -1).normalize()
                scene.add(light)

                const loader = new GLTFLoader();

                // Install GLTFLoader plugin
                loader.register((parser) => {
                    return new VRMLoaderPlugin(parser);
                });

                loader.load(
                    // URL of the VRM you want to load
                    '/models/AliciaSolid.vrm',

                    // called when the resource is loaded
                    (gltf) => {
                        // retrieve a VRM instance from gltf
                        vrm = gltf.userData.vrm;

                        scene.add(vrm.scene);

                        console.log(vrm);
                    },

                    // called while loading is progressing
                    (progress) => console.log('Loading model...', 100.0 * (progress.loaded / progress.total), '%'),

                    // called when loading has errors
                    (error) => console.error(error),
                );
                
                const update = () => {
                    requestAnimationFrame(update)
                    renderer.render(scene, camera)
                }
                update()
            })
            
            const startWebSocketButton = document.getElementById('startWebSocket');
            const stopWebSocketButton = document.getElementById('stopWebSocket');

            var ws;
            function startWebSocket() {
                var vrmpose = {};
                ws = new WebSocket('ws://localhost:8080');

                ws.onopen = function(event) {
                    console.log('WebSocket connection opened');
                    vrmpose = {}
                };

                ws.onmessage = function(event) {

                    // console.log(pose_data) // なぜかこれが空にならない

                    var msg = event.data;
                    console.log('Received message: ' + msg);
                    var element = document.getElementById('messages');
                    element.innerHTML += msg + '<br />';

                    // メッセージをパース
                    let message = event.data;
                    let parts = message.replace(/[\('"\)]/g, "").split(',').map(part => part.trim());
                    let name = parts[0];
                    let position = [parseFloat(parts[1]), parseFloat(parts[2]), parseFloat(parts[3])];
                    let rotation = [parseFloat(parts[4]), parseFloat(parts[5]), parseFloat(parts[6]), parseFloat(parts[7])];

                    // 新しいデータオブジェクトを作成
                    vrmpose[name] = {
                        position: position,
                        rotation: rotation
                    };

                    // 次のRootデータが来たら、現在のデータを出力してリセット
                    if (name == 'root' && Object.keys(vrmpose).length > 1) {
                        console.log(vrmpose);
                        vrm.humanoid.setPose(vrmpose)
                        vrmpose = {};
                        vrmpose[name] = {
                            position: position,
                            rotation: rotation
                        };
                    }

                };

                ws.onclose = function(event) {
                    console.log('WebSocket connection closed');
                    vrmpose = {}
                };
            }

            function stopWebSocket() {
                ws.close();
            }
        
            startWebSocketButton.addEventListener('click', startWebSocket)
            stopWebSocketButton.addEventListener('click', stopWebSocket)

        </script>

    </head>
    <body>

        <div id="canvas" style="width:640px;height:480px;"></div>
        <button id="startWebSocket">Start</button>
        <button id="stopWebSocket">Stop</button>
        <div id="messages"></div>

    </body>
</html>